import{resolveWhitespacePosition as k,lineNumbers as N,collapsedLines as H}from"@vuepress/highlighter-helper";import{isPlainObject as W}from"vuepress/shared";import{Logger as E,getModulePath as p}from"@vuepress/helper";import{customAlphabet as P}from"nanoid";import{createRequire as C}from"node:module";import{createHighlighter as T,isSpecialLang as x}from"shiki";import{createSyncFn as F}from"synckit";import{transformerNotationDiff as M,transformerNotationFocus as j,transformerNotationHighlight as S,transformerNotationErrorLevel as q,transformerNotationWordHighlight as D,transformerMetaWordHighlight as O,transformerRenderWhitespace as R,transformerCompactLineOptions as _}from"@shikijs/transformers";import{colors as m}from"vuepress/utils";const G=t=>{const e={},i=t.render.bind(t);return t.render=(r,s={})=>(e.path=s.filePathRelative,i(r,s)),()=>e.path||"dynamic pages"},I=/-vue$/,v="@vuepress/plugin-shiki",$=new E(v),U=P("abcdefghijklmnopqrstuvwxyz",10),d=t=>t.match(/^([^ :[{]+)/)?.[1]?.replace(I,"").toLowerCase()??"",z=(t,e)=>{const i=`\\b${e}\\s*=\\s*(?<quote>['"])(?<content>.+?)\\k<quote>(\\s|$)`,r=new RegExp(i,"i");return t.match(r)?.groups?.content??null},B=t=>{const e=t.replace(/^(?:\[.*?\])?.*?([\d,-]+).*/,"$1").trim(),i=[];return e?(e.split(",").map(r=>r.split("-").map(s=>parseInt(s,10))).forEach(([r,s])=>{r&&s?i.push(...Array.from({length:s-r+1},(n,l)=>r+l)):i.push(r)}),i.map(r=>({line:r,classes:["highlighted"]}))):[]},J=C(import.meta.url),K=F(J.resolve("@vuepress/plugin-shiki/resolveLang")),Q=async({langs:t=[],langAlias:e={},defaultLang:i,shikiSetup:r,...s}={})=>{const n=await T({langs:[...t,...Object.values(e)],langAlias:e,themes:"themes"in s?Object.values(s.themes):[s.theme??"nord"]}),l=o=>{if(x(o))return!0;if(!n.getLoadedLanguages().includes(o)){const c=K(o);if(!c.length)return!1;n.loadLanguageSync(c)}return!0},h=n.getLanguage;return n.getLanguage=o=>{const c=typeof o=="string"?o:o.name;return l(d(c)),h.call(n,o)},await r?.(n),{highlighter:n,loadLang:l}},V=/\[\\!code/g,X={name:"vuepress:add-class",pre(t){this.addClassToHast(t,"vp-code")}},Y={name:"vuepress:cleanup",pre(t){delete t.properties.tabindex}},Z={name:"vuepress:remove-escape",postprocess(t){return t.replace(V,"[!code")}},ee={name:"vuepress:empty-line",code(t){t.children.forEach(e=>{e.type==="element"&&e.tagName==="span"&&Array.isArray(e.properties.class)&&e.properties.class.includes("line")&&e.children.length===0&&e.children.push({type:"element",tagName:"wbr",properties:{},children:[]})})}},te=t=>{const e=[];return t.notationDiff&&e.push(M({matchAlgorithm:"v3"})),t.notationFocus&&e.push(j({classActiveLine:"has-focus",classActivePre:"has-focused-lines",matchAlgorithm:"v3"})),t.notationHighlight&&e.push(S({matchAlgorithm:"v3"})),t.notationErrorLevel&&e.push(q({matchAlgorithm:"v3"})),t.notationWordHighlight&&(e.push(D({matchAlgorithm:"v3"})),e.push(O())),e.push(X,Y,Z,ee),e},re=(t,e=!1)=>{const i=k(t,e);return i===!1?[]:[R({position:i})]},L=new Set,se=(t,{defaultLang:e,logLevel:i},r,s)=>{let n=d(t);return n&&!r(n)&&(i!=="silent"&&!L.has(n)&&($.warn(`Missing ${m.cyan(t)} highlighter, ${e?`use ${m.cyan(e)} to highlight instead.`:"skip highlighting"}`),L.add(n)),i==="debug"&&$.info(`Unknown language ${m.cyan(n)} found in ${m.cyan(s())}`),n=e||"plain"),n},ie=/\{\{[^]*?\}\}/g,ne=(t,e)=>t.replace(ie,i=>{let r=e.get(i);return r||(r=U(),e.set(i,r)),r}),oe=(t,e)=>{let i=t;return e.forEach((r,s)=>{i=i.replaceAll(r,s)}),i},ae=(t,e)=>{const i=new Map;return oe(e(ne(t,i).trimEnd()),i)},le=(t,e,i,r)=>{const s=te(e);return(n,l,h)=>ae(n,o=>t.codeToHtml(o,{lang:se(l,e,i,r),meta:{__raw:h},transformers:[...s,...e.highlightLines??!0?[_(B(h))]:[],...re(h,e.whitespace),...e.transformers??[]],..."themes"in e?{themes:e.themes,defaultColor:!1}:{theme:e.theme??"nord"}}))},y=/{([\d,-]+)}/,he=t=>{const e=t.renderer.rules.fence;t.renderer.rules.fence=(...i)=>{const[r,s]=i,n=r[s],l=n.info||"",h=l.match(y);if(!h)return e(...i);n.info=l.replace(y,"").trim();const o=h[1];return n.info+=` ${o}`,e(...i)}},pe=/<pre([\s\S]*?)style="([^"]*)"([^>]*)>/,ce=(t,{preWrapper:e=!0}={})=>{const i=t.renderer.rules.fence;t.renderer.rules.fence=(...r)=>{let s=i(...r);if(!s.startsWith("<pre"))return s;const[n,l,h]=r,o=n[l],c=o.info?t.utils.unescapeAll(o.info).trim():"",a=d(c),g=`${h.langPrefix}${a}`;if(!e)return s=s.replace(/<code[^]*?>/,"<code>"),s=`<pre class="${g}"${s.slice(4)}`,s;const u=z(c,"title")||a;let f="";return s=s.replace(pe,(me,w,b,A)=>(f=b.trim(),`<pre ${w.trim()}${A.trimEnd()}>`)),`<div class="${g}" data-highlighter="shiki" data-ext="${a}" data-title="${u}" style="${f}">${s}</div>`}},ge=(t,{lineNumbers:e=!0,highlightLines:i=!0,collapsedLines:r="disable",notationDiff:s,notationErrorLevel:n,notationFocus:l,notationHighlight:h,notationWordHighlight:o,whitespace:c})=>{const a=[`import "${p("@vuepress/highlighter-helper/styles/base.css",import.meta)}"`,`import "${p(`${v}/styles/shiki.css`,import.meta)}"`],g=[];e!=="disable"&&a.push(`import "${p("@vuepress/highlighter-helper/styles/line-numbers.css",import.meta)}"`),(i||h)&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-highlight.css",import.meta)}"`),s&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-diff.css",import.meta)}"`),n&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-error-level.css",import.meta)}"`),l&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-focus.css",import.meta)}"`),h&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-highlight.css",import.meta)}"`),o&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-word-highlight.css",import.meta)}"`),c&&a.push(`import "${p("@vuepress/highlighter-helper/styles/whitespace.css",import.meta)}"`),r!=="disable"&&(a.push(`import "${p("@vuepress/highlighter-helper/styles/collapsed-lines.css",import.meta)}"`,`import { setupCollapsedLines } from "${p("@vuepress/highlighter-helper/client",import.meta)}"`),g.push("setupCollapsedLines()"));let u=a.join(`
`);return g.length&&(u+=`

export default {
  setup() {
    ${g.join(`
    `)}
  }
}
`),t.writeTemp("shiki/config.js",u)},ue=(t={})=>e=>{const{code:i}=e.options.markdown,r={...W(i)?i:{},...t};return r.logLevel??=e.env.isDebug?"debug":"warn",r.preWrapper??=!0,r.lineNumbers??=!0,r.collapsedLines??="disable",{name:"@vuepress/plugin-shiki",extendsMarkdown:async s=>{const{preWrapper:n,lineNumbers:l,collapsedLines:h}=r,o=G(s),{highlighter:c,loadLang:a}=await Q(r);s.options.highlight=le(c,r,a,o),s.use(he),s.use(ce,{preWrapper:n}),n&&(s.use(N,{lineNumbers:l}),s.use(H,{collapsedLines:h}))},clientConfigFile:()=>ge(e,r)}};export{ue as shikiPlugin};
//# sourceMappingURL=index.js.map
